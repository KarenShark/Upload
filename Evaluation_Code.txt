keys = ['VERSION_DATE','CUST_SERIAL_NO']

# 1) customer-date 唯一性（宽表）
assert wide.duplicated(keys).sum() == 0
assert wide.shape[0] == cands[keys].drop_duplicates().shape[0]

# 2) 明细表最多 3 条、且同一 customer-date 内产品不重复
assert final_topk.groupby(keys).size().max() <= 3
assert final_topk.duplicated(keys + ['candidate_product']).sum() == 0

# 3) 三个月是否覆盖对齐
print('customer-date pairs by month:\n',
      pred.groupby('VERSION_DATE')['CUST_SERIAL_NO'].nunique())

# 4) 三个月合并后的“唯一个客数”（和 30304 不同的口径）
print('unique customers across 3 months:',
      pred['CUST_SERIAL_NO'].nunique())