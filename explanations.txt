global vs segment 只影响 \text{value}(a) 的精细度：没有 segment 也能跑，只是“客群差异”会被平均化。
readiness = 可切换性（小边际 + 高不确定）；benefit = 换法能多赚的钱；
diversity_score = readiness × benefit_norm：既看“能不能换”，也看“换了值不值”。

我们不为了“多样化而多样化”。只有当：
	1.	这位客户当期适合被切换（readiness 高），且
	2.	从 Top-1 换到另一个同样合理的候选（Top-2/3）能带来可观的期望收益增量（benefit 大），
才判定这位客户“值得多元化”。



下面这段内容可直接粘贴到 JupyterHub 的 Markdown 单元中使用（已用 LaTeX 公式排版）。

⸻

Diversity Potential × Diversity Benefit（with Segment/Global Value Modeling）

Intuition（直觉）

我们不为了“多样化而多样化”。只有当：
	1.	这位客户当期适合被切换（readiness 高），且
	2.	从 Top-1 换到另一个同样合理的候选（Top-2/3）能带来可观的期望收益增量（benefit 大），
才判定这位客户“值得多元化”。

⸻

Variables（当前实现用到的数据）
	•	Top-K 候选与分数：
rec1_candidate_product, rec2_candidate_product, rec3_candidate_product；
rec1_score, rec2_score, rec3_score ∈ [0,1]（若没有概率，先用分位缩放的分数作占位）。
	•	训练窗（≤ 2024-09-30）的产品价值参考（被接受后的平均收益，winsorize）：
对每个 (\text{segment}, \text{product}) 计算：
\text{value}(a) \equiv
\begin{cases}
\mathbb{E}[\text{Rev} \mid \text{accepted}=1,\ \text{segment},\ a], & n_{\text{segment},a}\ge 50\\[4pt]
\mathbb{E}[\text{Rev} \mid \text{accepted}=1,\ a], & \text{（样本不足）回退到全局 product}\\
\end{cases}
若仍缺失则回退 0。没有 segment 也能跑（全部走全局）。

⸻

1) Baseline Expected Value（基线期望价值）

当前上线策略≈“总是发 Top-1”。
V_{\text{base}}=\text{EV}(\text{rec1}),
\qquad
\text{EV}(a) = p(a)\cdot \text{value}(a)
其中 p(a) 为候选接受概率（当前用 rec{k}_score 的校准/缩放值作占位）。

⸻

2) Best Alternative & Raw Benefit（最佳备选与原始增益）

只在 Top-2/3 中选与 Top-1 不同且合规的最佳备选：
\[
V_{\text{alt}}^\=\max\{\text{EV}(\text{rec2}),\ \text{EV}(\text{rec3})\}
\]
\[
B=\max\bigl(0,\ V_{\text{alt}}^\-V_{\text{base}}\bigr)
\]

这一步把“多元化”直接与“能多赚多少钱”绑定，而不是仅看分布是否更均匀。

⸻

3) Readiness（多元化潜力/可切换性）

用 概率边际 + 概率熵（来自 Top-K 概率/分数）：
p_k=\frac{s_k}{\sum_{j=1}^3 s_j},\quad
\text{margin}=p_1-p_2,\quad
H=-\sum_{k=1}^3 p_k\log p_k\ \big/ \ \log 3
\text{readiness}=\sigma\!\left((1-\text{margin})+0.5\cdot H\right)\in(0,1),
\qquad \sigma(x)=\frac{1}{1+e^{-x}}
直觉：越分散（熵高）且 Top-1 与 Top-2 差距越小（margin 低），越“可切换”。

简化门控（可选）：若暂时只想用 Top-1 置信度，
\text{readiness}=0.5+0.5\times \text{rec1\_score}\in[0.5,1]
将来有 \text{engagement\_proba} 后可直接替换。

⸻

4) Normalized Benefit（收益归一化，便于客户间可比）

为避免极端值主导，把 B 做分位归一化（示例做法）：
Q=\text{p99}(B\mid B>0),\qquad
b=\min\!\left(\frac{B}{Q},\ 1\right)\in[0,1]

⸻

Final Scores（最终指标）
	•	Diversity benefit（金额）：
\text{benefit}=B
可对 cohort 求和/均值用于业务汇总。
	•	Diversity potential（排序/触发）：
\text{diversity\_score}=\text{readiness}\times b\in[0,1]
只有可切换（readiness 高）且有钱可赚（b 高）时，分数才高。

⸻

Why this works（老板关心的 3 点）
	1.	价值对齐：核心量 \(V_{\text{alt}}^\*-V_{\text{base}}\) 直接回答“换推荐能多赚多少”。
	2.	可运营：设阈值（如 readiness ≥ 0.8 且 b ≥ p75）即可得到 share_diversified 与预期增收，便于算 ROI。
	3.	可进化：占位清晰——有了 \text{engagement\_proba}、更细的 \text{value}(a\mid \text{segment})、以及资格/频控规则，主逻辑不变，精度更高。

⸻

Segment vs. Global（它们影响什么）
	•	仅影响 \text{value}(a)，从而影响 benefit；readiness 与 segment 无关。
	•	有 segment：价值更“个性化”，benefit 更贴近客群真实贡献；
	•	无 segment：也完全可用（更稳），但更“均值化”，个体差异刻画偏弱。